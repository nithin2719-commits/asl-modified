<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignFlow - ASL Recognition Platform</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="login-container">
        <!-- Animated Background -->
        <div class="animated-bg">
            <div class="aurora-layer"></div>
            <div class="grid-layer"></div>
            <div class="floating-shapes">
                <div class="shape shape-1"></div>
                <div class="shape shape-2"></div>
                <div class="shape shape-3"></div>
                <div class="shape shape-4"></div>
            </div>
            <div class="signal-orbit">
                <span class="orbit-dot"></span>
                <span class="orbit-dot"></span>
                <span class="orbit-dot"></span>
            </div>
        </div>

        <!-- Main Login Content -->
        <div class="login-content">
            <!-- Logo and Branding -->
            <div class="brand-section">
                <div class="logo-container">
                    <div class="logo-orbital">
                        <span class="orbital-ring"></span>
                        <i class="fas fa-sign-language"></i>
                    </div>
                    <div>
                        <h1 class="brand-name">SignFlow</h1>
                        <p class="brand-sub">ASL Live Interpreter</p>
                    </div>
                </div>
                <p class="brand-tagline">Meet the ASL login that feels alive.</p>
                <div class="brand-features">
                    <div class="feature-item">
                        <i class="fas fa-video"></i>
                        <span>Real-time ASL Recognition</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-users"></i>
                        <span>Video Calling Interface</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-brain"></i>
                        <span>AI-Powered Detection</span>
                    </div>
                </div>

                <div class="live-badges">
                    <span class="meta-pill"><span class="dot"></span> Edge inference</span>
                    <span class="meta-pill"><i class="fas fa-shield-alt"></i> Encrypted session</span>
                    <span class="meta-pill"><i class="fas fa-bolt"></i> Sub-100ms UI</span>
                </div>

            </div>

            <!-- Login Form -->
            <div class="login-form-container">
                <div class="form-header">
                    <h2>Welcome Back</h2>
                    <p>Sign in to start your ASL conversation</p>
                </div>

                <div class="role-context show" id="role-context">
                    Signer mode primed. Camera and mic will stay local to you.
                </div>

                <div class="role-toggle" aria-label="Choose role">
                    <button type="button" class="role-chip active" data-role-pick="primary">
                        <i class="fas fa-hand-sparkles"></i>
                        Signer
                        <span class="chip-note">Camera + mic</span>
                    </button>
                    <button type="button" class="role-chip" data-role-pick="secondary">
                        <i class="fas fa-eye"></i>
                        Reader
                        <span class="chip-note">Transcript mode</span>
                    </button>
                </div>

                <div class="quick-actions demo-actions" aria-label="Demo shortcuts">
                    <button type="button" class="quick-action ghost" id="back-home">
                        <i class="fas fa-house"></i>
                        Back home
                    </button>
                </div>

                <form id="login-form" class="login-form">
                    <input type="hidden" id="role-field" name="role" value="primary">
                    <div class="form-group">
                        <label for="username">
                            <i class="fas fa-user"></i>
                            Username
                        </label>
                        <input type="text" id="username" name="username" required placeholder="Enter your username">
                        <div class="input-line"></div>
                    </div>

                    <div class="form-group">
                        <label for="password">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <div class="input-wrap">
                            <input type="password" id="password" name="password" required placeholder="Enter your password">
                            <button type="button" class="toggle-password" id="toggle-password" aria-label="Show password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="input-line"></div>
                    </div>

                    <div class="form-options">
                        <label class="checkbox-container">
                            <input type="checkbox" id="remember">
                            <span class="checkmark"></span>
                            Remember me
                        </label>
                        <a href="#" class="forgot-password">Forgot Password?</a>
                    </div>

                    <div class="button-grid">
                        <button type="submit" class="login-btn">
                            <span class="btn-text">Sign In</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>

                        <a class="signup-btn" id="signup-btn" href="/signup">
                            <span class="btn-text">Create Account</span>
                            <i class="fas fa-user-plus"></i>
                        </a>
                    </div>
                </form>

                <div class="login-hint" id="login-hint" aria-live="polite"></div>

                <div class="signup-prompt">
                    <p>Don't have an account?
                        <a href="/signup" id="signup-link">Create one now</a>
                    </p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Form handling
        const loginForm = document.getElementById('login-form');
        const signupLink = document.getElementById('signup-link');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password');
        const usernameInput = document.getElementById('username');
        const roleContext = document.getElementById('role-context');
        const loginHint = document.getElementById('login-hint');
        const roleChips = document.querySelectorAll('[data-role-pick]');
        const roleField = document.getElementById('role-field');
        const lastUser = localStorage.getItem('signflowLastUser');
        const backHomeBtn = document.getElementById('back-home');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = usernameInput.value;
            const password = passwordInput.value;
            loginHint.textContent = '';
            loginHint.classList.remove('show');

            if (username && password) {
                // Show loading state
                const btn = loginForm.querySelector('.login-btn');
                const btnText = btn.querySelector('.btn-text');
                btnText.textContent = 'Signing in...';
                btn.disabled = true;

                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, role: roleField.value || 'primary' })
                    });
                    const isJson = response.headers.get('content-type')?.includes('application/json');
                const result = isJson ? await response.json() : { detail: await response.text() };
                if (!response.ok) {
                    throw new Error(result.detail || 'Login failed');
                }
                if (result.created) {
                    loginHint.textContent = 'Account created automatically. Signing you in...';
                    loginHint.classList.add('show');
                }
                localStorage.setItem('signflowLastUser', username);
                localStorage.setItem('signflowRole', roleField.value || 'primary');
                window.location.href = '/call';
            } catch (err) {
                loginHint.textContent = err.message || 'Login failed. Please try again.';
                loginHint.classList.add('show');
            } finally {
                    btnText.textContent = 'Sign In';
                    btn.disabled = false;
                }
            } else {
                loginHint.textContent = 'Please enter a username and password to continue.';
                loginHint.classList.add('show');
                loginForm.classList.add('shake');
                setTimeout(() => loginForm.classList.remove('shake'), 400);
            }
        });

        signupLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '/signup';
        });

        if (backHomeBtn) {
            backHomeBtn.addEventListener('click', () => {
                window.location.href = '/';
            });
        }

        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            togglePasswordBtn.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        });

        // Role-aware hints from the new homepage
        const params = new URLSearchParams(window.location.search);
        const roleParam = (params.get('role') || '').toLowerCase();
        const userParam = params.get('user') || '';
        const roleLookup = {
            primary: { label: 'Signer', userPlaceholder: 'Enter signer username', passPlaceholder: 'Enter password' },
            signer: { label: 'Signer', userPlaceholder: 'Enter signer username', passPlaceholder: 'Enter password' },
            secondary: { label: 'Reader', userPlaceholder: 'Enter reader username', passPlaceholder: 'Enter password' },
            reader: { label: 'Reader', userPlaceholder: 'Enter reader username', passPlaceholder: 'Enter password' }
        };

        function normalizeRole(roleKey) {
            if (roleKey === 'signer') return 'primary';
            if (roleKey === 'reader') return 'secondary';
            return roleKey;
        }

        function applyRole(roleKey, autofill = false) {
            const info = roleLookup[roleKey];
            if (!info) return;
            const normalizedRole = normalizeRole(roleKey);
            roleChips.forEach(c => c.classList.toggle('active', c.dataset.rolePick === normalizedRole));
            roleField.value = normalizedRole;
            localStorage.setItem('signflowRole', normalizedRole);
            if (autofill && lastUser) {
                usernameInput.value = lastUser;
            } else if (!usernameInput.value) {
                usernameInput.placeholder = info.userPlaceholder;
            }
            passwordInput.placeholder = info.passPlaceholder;
            if (roleContext) {
                roleContext.textContent = normalizedRole === 'primary'
                    ? 'Signer mode primed. Camera + mic stay on-device.'
                    : 'Reader mode tuned for mirrored video and transcripts.';
            }
        }

        const savedRole = localStorage.getItem('signflowRole');
        if (roleLookup[roleParam]) {
            applyRole(roleParam, false);
        } else if (roleLookup[savedRole]) {
            applyRole(savedRole, false);
        } else {
            applyRole('primary', false);
        }

        if (userParam && !usernameInput.value) {
            usernameInput.value = userParam;
        }


        // Role chips (also fill credentials)
        roleChips.forEach(chip => {
            chip.addEventListener('click', () => {
                const role = chip.dataset.rolePick;
                applyRole(role, true);
                passwordInput.focus();
            });
        });

        if (loginGoogle) {
            loginGoogle.addEventListener('click', () => {
                if (!googleEnabled) {
                    loginHint.textContent = 'Google sign-in is not configured. Please use username/password.';
                    loginHint.classList.add('show');
                    return;
                }
                window.location.href = '/auth/google?flow=login&next=/call';
            });
        }
        if (loginGithub) {
            loginGithub.addEventListener('click', () => {
                if (!githubEnabled) {
                    loginHint.textContent = 'GitHub sign-in is not configured. Please use username/password.';
                    loginHint.classList.add('show');
                    return;
                }
                window.location.href = '/auth/github?flow=login&next=/call';
            });
        }

        // Animated background effects
        document.addEventListener('mousemove', (e) => {
            const shapes = document.querySelectorAll('.shape');
            shapes.forEach((shape, index) => {
                const speed = (index + 1) * 0.5;
                const x = (window.innerWidth - e.pageX * speed) / 100;
                const y = (window.innerHeight - e.pageY * speed) / 100;
                shape.style.transform = `translateX(${x}px) translateY(${y}px)`;
            });
        });

        // Input focus effects
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('focus', () => {
                input.parentElement.classList.add('focused');
            });

            input.addEventListener('blur', () => {
                if (!input.value) {
                    input.parentElement.classList.remove('focused');
                }
            });
        });

    </script>
</body>
</html>
